<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ü—Ä–æ–ø–æ–≤–µ–¥–Ω–∏–∫–∞ (–¥–µ–º–æ)</title>

    <!-- Tailwind + Quill -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <!-- –í–Ω–µ—à–Ω–∏–µ —Ñ–∞–π–ª—ã -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="storage.js"></script>

<script type="module">
    // –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    import App from './app.js'; // –ø–æ—Ç–æ–º —Å–æ–∑–¥–∞–¥–∏–º
    // –∏–ª–∏ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    window.addEventListener('DOMContentLoaded', () => {
        // App.init() –±—É–¥–µ—Ç –ø–æ–∑–∂–µ
    });
</script>


 <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        :root {
            --font-main: 'Inter', sans-serif;
            --text-color: #1f2937;
            --heading-color: #111827;
            --font-base: 1.125rem;
            --font-h1: 1.5rem;
            --font-h2: 1.25rem;
            --font-h3: 1.125rem;
            --line-height: 1.6;
        }

        body {
            font-family: var(--font-main);
            background-color: #f7f9fb;
        }

        /* Quill —Ä–µ–¥–∞–∫—Ç–æ—Ä */
        .ql-editor {
            font-family: var(--font-main) !important;
            font-size: var(--font-base) !important;
            line-height: var(--line-height) !important;
            color: var(--text-color) !important;
            padding: 0 !important;
        }
        .ql-editor h1 { font-size: var(--font-h1); font-weight: 700; color: var(--heading-color);
                        margin: 1em 0 .5em; border-bottom: 1px solid #e5e7eb; padding-bottom: .2em; }
        .ql-editor h2 { font-size: var(--font-h2); font-weight: 600; color: var(--heading-color);
                        margin: 1em 0 .5em; }
        .ql-editor h3 { font-size: var(--font-h3); font-weight: 500; color: var(--text-color);
                        margin: 1em 0 .5em; }
        .ql-editor p { margin-bottom: .75em; }
        .ql-editor ul, .ql-editor ol { margin-left: 1.25rem; margin-bottom: .75em; }
        .ql-editor li { margin-bottom: .25em; padding-left: .25em; }

        /* AI-–±–ª–æ–∫–∏ */
        #exegesis-content, #illustration-content, #structure-content, 
        #theology-content, #style-content, #questions-content {
            font-family: var(--font-main);
            font-size: var(--font-base);
            line-height: var(--line-height);
            color: var(--text-color);
        }
        #exegesis-content h1, #illustration-content h1, #structure-content h1,
        #theology-content h1, #style-content h1, #questions-content h1 {
            font-size: var(--font-h1); font-weight: 700; color: var(--heading-color);
            margin: 1em 0 .5em; border-bottom: 1px solid #e5e7eb; padding-bottom: .2em;
        }
        #exegesis-content h2, #illustration-content h2, #structure-content h2,
        #theology-content h2, #style-content h2, #questions-content h2 {
            font-size: var(--font-h2); font-weight: 600; color: var(--heading-color);
            margin: 1em 0 .5em;
        }
        #exegesis-content h3, #illustration-content h3, #structure-content h3,
        #theology-content h3, #style-content h3, #questions-content h3 {
            font-size: var(--font-h3); font-weight: 500; color: var(--text-color);
            margin: 1em 0 .5em;
        }
        #exegesis-content p, #illustration-content p, #structure-content p,
        #theology-content p, #style-content p, #questions-content p { margin-bottom: .75em; }
        #exegesis-content ul, #exegesis-content ol,
        #illustration-content ul, #illustration-content ol,
        #structure-content ul, #structure-content ol,
        #theology-content ul, #theology-content ol,
        #style-content ul, #style-content ol,
        #questions-content ul, #questions-content ol {
            list-style-type: disc; margin-left: 1.25rem; margin-bottom: .75em;
        }
        #exegesis-content li, #illustration-content li, #structure-content li,
        #theology-content li, #style-content li, #questions-content li {
            margin-bottom: .25em; padding-left: .25em;
        }

        /* –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã */
        .assistant-card { box-shadow: 0 4px 8px rgba(0,0,0,.1); transition: transform .2s ease; }
        .btn-assist { background-color: #2c7a7b; transition: background-color .3s; }
        .btn-assist:hover:not(:disabled) { background-color: #235d5e; }
        .btn-assist:disabled { background-color: #81c7c7; cursor: not-allowed; }

        .loading-spinner {
            border: 3px solid #e5e7eb; border-top-color: #2c7a7b;
            animation: spin .8s ease-in-out infinite; border-radius: 50%;
            width: 1.5rem; height: 1.5rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .sermon-item { transition: all .2s; cursor: pointer; }
        .sermon-item:hover { background-color: #e0f2f1; transform: translateX(3px); }
        .sermon-item.active { background-color: #b2dfdb; border-left: 3px solid #2c7a7b; }

        .status-badge { font-size: .65rem; padding: .2rem .4rem; border-radius: 9999px; }
        .status-draft { background-color: #fef3c7; color: #92400e; }
        .status-ready { background-color: #dbeafe; color: #1e40af; }
        .status-preached { background-color: #d1fae5; color: #065f46; }
        .status-archived { background-color: #f3f4f6; color: #6b7280; }

        input[aria-invalid="true"], select[aria-invalid="true"] {
            border-color: #ef4444; background-color: #fef2f2;
        }

        .tooltip { position: relative; }
        .tooltip .tooltip-text {
            visibility: hidden; width: 200px; background-color: #374151; color: #fff;
            text-align: center; border-radius: 6px; padding: 5px; position: absolute;
            z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0;
            transition: opacity .3s; font-size: .75rem;
        }
        .tooltip:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* –ö–Ω–æ–ø–∫–∏ –≤ —à–∞–ø–∫–µ */
        #sermon-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        #sermon-actions button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.5rem 0.875rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            white-space: nowrap;
            min-height: 2rem;
        }
        #sermon-actions button svg {
            width: 0.875rem;
            height: 0.875rem;
            margin-right: 0.375rem;
            flex-shrink: 0;
        }
        #sermon-actions .btn-help { background-color: #f3f4f6; color: #374151; }
        #sermon-actions .btn-help:hover { background-color: #e5e7eb; }
        #sermon-actions .btn-delete { background-color: #fee2e2; color: #991b1b; }
        #sermon-actions .btn-delete:hover { background-color: #fecaca; }
        #sermon-actions .btn-save { background-color: #d1fae5; color: #065f46; }
        #sermon-actions .btn-save:hover { background-color: #a7f3d0; }
        #sermon-actions .btn-export { background-color: #dbeafe; color: #1e40af; }
        #sermon-actions .btn-export:hover { background-color: #bfdbfe; }
        
        .welcome-btn-grid {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .welcome-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            min-width: 180px;
        }
        .welcome-btn svg {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 0.5rem;
        }

        @media (max-width: 640px) {
            .assistant-card { padding: .75rem; }
            input, select { font-size: .875rem; padding: .5rem; }
            #editor { height: 350px; }
            .tooltip .tooltip-text { width: 150px; margin-left: -75px; }
            #sermon-actions { justify-content: center; }
        }

        /* –ö–Ω–æ–ø–∫–∞ –ë–∏–±–ª–∏—è */
        .ql-toolbar .ql-bible {
            background-color: #2c7a7b !important;
            color: white !important;
            border-radius: 6px !important;
            padding: 4px 8px !important;
            margin: 0 2px !important;
            transition: all 0.2s ease !important;
            min-width: 65px !important;
            width: auto !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .ql-toolbar .ql-bible:hover {
            background-color: #235d5e !important;
            transform: scale(1.05) !important;
            box-shadow: 0 2px 8px rgba(44, 122, 123, 0.4) !important;
        }
        .ql-toolbar .ql-bible svg { stroke: white !important; }
        .ql-toolbar .ql-bible span { white-space: nowrap !important; font-size: 11px !important; font-weight: 500 !important; }

        /* –í–∫–ª–∞–¥–∫–∏ –ø–æ–º–æ—â–∏ */
        .tab-active {
            border-b-2 !important;
            border-color: #2c7a7b !important;
            color: #2c7a7b !important;
            font-weight: 600 !important;
        }
        .tab-inactive {
            border-color: transparent !important;
            color: #6b7280 !important;
        }
        .tab-inactive:hover {
            color: #2c7a7b !important;
        }

        /* –í–∫–ª–∞–¥–∫–∏ AI */
        .ai-tab {
            border-b-2 !important;
            border-color: transparent !important;
            transition: all 0.2s;
        }
        .ai-tab-active {
            border-color: #2c7a7b !important;
            color: #2c7a7b !important;
            font-weight: 600 !important;
        }
        .ai-tab svg {
            vertical-align: middle;
        }
        .ai-content-panel {
            display: none;
        }
        .ai-content-panel.active {
            display: block;
        }

        /* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ–º–ø—Ç—ã */
        .custom-prompt-item {
            transition: all 0.2s;
            cursor: pointer;
        }
        .custom-prompt-item:hover {
            background-color: #f3f4f6;
            transform: translateX(2px);
        }
        .badge-custom {
            background-color: #fbbf24;
            color: #92400e;
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
            border-radius: 9999px;
            font-weight: 600;
        }
    </style>

</head>

<body class="flex h-screen overflow-hidden">

    <!-- ====================== SIDEBAR ====================== -->
    <aside id="sidebar" class="w-72 bg-white border-r border-gray-200 flex flex-col">
        <div class="p-3 border-b border-gray-200">
            <h2 class="text-lg font-bold text-[#2c7a7b] mb-2">–ú–æ–∏ –ü—Ä–æ–ø–æ–≤–µ–¥–∏</h2>
            <button onclick="App.createNewSermon()"
                    class="w-full bg-[#2c7a7b] text-white font-semibold py-1.5 px-3 rounded-md hover:bg-[#235d5e] transition flex items-center justify-center"
                    aria-label="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø—Ä–æ–ø–æ–≤–µ–¥—å">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                –ù–æ–≤–∞—è –ü—Ä–æ–ø–æ–≤–µ–¥—å
            </button>
        </div>

        <div id="sermons-list" class="flex-1 overflow-y-auto p-2"></div>

        <div class="p-3 border-t border-gray-200 space-y-1.5">
            <button onclick="App.exportToJSON()"
                    class="w-full bg-gray-100 text-gray-700 font-medium py-1.5 px-3 rounded-md hover:bg-gray-200 transition text-xs flex items-center justify-center"
                    aria-label="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ JSON">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                –≠–∫—Å–ø–æ—Ä—Ç JSON
            </button>

            <label class="w-full bg-gray-100 text-gray-700 font-medium py-1.5 px-3 rounded-md hover:bg-gray-200 transition text-xs flex items-center justify-center cursor-pointer"
                   aria-label="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ JSON">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                –ò–º–ø–æ—Ä—Ç JSON
                <input type="file" id="import-file" accept=".json" onchange="App.importFromJSON(event)" class="hidden">
            </label>
        </div>
    </aside>

    <!-- ====================== MAIN ====================== -->
    <main class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white border-b border-gray-200 p-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-extrabold text-[#2c7a7b]" id="main-title">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ü—Ä–æ–ø–æ–≤–µ–¥–Ω–∏–∫–∞ (–¥–µ–º–æ)</h1>
                    <p class="text-gray-600 text-sm mt-1" id="main-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–ø–æ–≤–µ–¥—å –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é</p>
                </div>
                <div id="sermon-actions" class="hidden space-x-1.5">
                    <button onclick="App.openHelpModal()"
                            class="bg-gray-100 text-gray-700 hover:bg-gray-200 flex items-center"
                            aria-label="–ü–æ–º–æ—â—å">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M8.228 9c.549-1.165 1.514-2 2.772-2 1.634 0 3 1.366 3 3 0 1.3-.836 2.4-2 2.8v.4m0 2.4v1.2m0-6v.8"/>
                        </svg>
                        –ü–æ–º–æ—â—å
                    </button>
                    <button onclick="App.deleteCurrentSermon()"
                            class="bg-red-100 text-red-700 hover:bg-red-200"
                            aria-label="–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–ø–æ–≤–µ–¥—å">–£–¥–∞–ª–∏—Ç—å</button>
                    <button onclick="App.saveCurrentSermon()"
                            class="bg-green-100 text-green-700 hover:bg-green-200"
                            aria-label="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–ø–æ–≤–µ–¥—å">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</button>
                    <button onclick="App.exportToDocx()"
                            class="bg-blue-100 text-blue-700 hover:bg-blue-200"
                            aria-label="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ DOCX">–≠–∫—Å–ø–æ—Ä—Ç –≤ DOCX</button>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4">

            <!-- ==== Welcome ==== -->
            <div id="welcome-screen" class="max-w-3xl mx-auto text-center py-16">
                <svg class="w-20 h-20 mx-auto mb-4 text-[#2c7a7b]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                </svg>
                <h2 class="text-xl font-bold text-gray-800 mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                <p class="text-gray-600 text-sm mb-4">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –ø—Ä–æ–ø–æ–≤–µ–¥—å –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ</p>
                <button onclick="App.createNewSermon()"
                        class="bg-[#2c7a7b] text-white font-bold py-2 px-5 rounded-md hover:bg-[#235d5e] transition"
                        aria-label="–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –ø—Ä–æ–ø–æ–≤–µ–¥—å">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –ø—Ä–æ–ø–æ–≤–µ–¥—å</button>
            </div>

            <!-- ==== Workspace ==== -->
            <div id="sermon-workspace" class="hidden max-w-6xl mx-auto">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="assistant-card bg-white p-4 rounded-lg border border-gray-200 mb-4">
                    <h3 class="text-base font-bold text-gray-800 mb-3">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–ø–æ–≤–µ–¥–∏ <span class="text-red-500">*</span></label>
                            <input type="text" id="sermon-title" onchange="App.updateSermonMetadata()"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#2c7a7b] focus:ring-offset-2 focus:border-[#2c7a7b]"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required>
                            <p id="sermon-title-error" class="hidden text-xs text-red-600 mt-1"></p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">–î–∞—Ç–∞ –ø—Ä–æ–ø–æ–≤–µ–¥–∏</label>
                            <input type="date" id="sermon-date" onchange="App.updateSermonMetadata()"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#2c7a7b] focus:ring-offset-2 focus:border-[#2c7a7b]">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">–°—Ç–∞—Ç—É—Å</label>
                            <select id="sermon-status" onchange="App.updateSermonMetadata()"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#2c7a7b] focus:ring-offset-2 focus:border-[#2c7a7b]">
                                <option value="draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                                <option value="ready">–ì–æ—Ç–æ–≤–∞</option>
                                <option value="preached">–ü—Ä–æ–ø–æ–≤–µ–¥–∞–Ω–∞</option>
                                <option value="archived">–ê—Ä—Ö–∏–≤</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label>
                            <input type="number" id="sermon-duration" onchange="App.updateSermonMetadata()"
                                   class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#2c7a7b] focus:ring-offset-2 focus:border-[#2c7a7b]"
                                   value="30" min="5" max="120">
                        </div>
                    </div>
                </div>

                <!-- AI –ü–æ–º–æ—â–Ω–∏–∫ -->
                <div class="assistant-card bg-white p-4 rounded-lg border border-gray-200 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-base font-bold text-gray-800">AI –ü–æ–º–æ—â–Ω–∏–∫</h3>
                        <button onclick="App.openCustomPromptModal()"
                                class="bg-amber-500 text-white font-medium py-1.5 px-3 rounded-md hover:bg-amber-600 transition text-xs flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            –°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
                        </button>
                    </div>
                    <div class="space-y-3 mb-4">
                        <div class="tooltip">
                            <label class="block text-xs font-medium text-gray-700 mb-1">–ë–∏–±–ª–µ–π—Å–∫–∏–π –û—Ç—Ä—ã–≤–æ–∫ <span class="text-red-500">*</span></label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="passage" list="book-list"
                                       onchange="App.validatePassage(this); App.updateSermonMetadata()"
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#2c7a7b] focus:ring-offset-2 focus:border-[#2c7a7b]"
                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö –†–∏–º–ª—è–Ω–∞–º 1:2" required>
                                <button onclick="App.showBookList()"
                                        class="bg-gray-200 text-gray-700 font-medium py-1.5 px-3 rounded-md hover:bg-gray-300 transition text-xs">–ö–Ω–∏–≥–∞</button>
                            </div>
                            <span class="tooltip-text">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –∏ –≥–ª–∞–≤—É/—Å—Ç–∏—Ö, –Ω–∞–ø—Ä–∏–º–µ—Ä: –ö –†–∏–º–ª—è–Ω–∞–º 1:2 –∏–ª–∏ –ò–æ–∞–Ω–Ω–∞ 3:16-18</span>
                            <datalist id="book-list"></datalist>
                            <p id="passage-error" class="hidden text-xs text-red-600 mt-1"></p>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">–¶–µ–ª–µ–≤–∞—è –ê—É–¥–∏—Ç–æ—Ä–∏—è</label>
                            <select id="audience" onchange="App.updateSermonMetadata()"
                                    class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#2c7a7b] focus:ring-offset-2 focus:border-[#2c7a7b]">
                                <option value="—Ä–∞–±–æ—Ç–∞—é—â–∏–µ –≤–∑—Ä–æ—Å–ª—ã–µ">–†–∞–±–æ—Ç–∞—é—â–∏–µ –≤–∑—Ä–æ—Å–ª—ã–µ</option>
                                <option value="–º–æ–ª–æ–¥–µ–∂—å –∏ —Å—Ç—É–¥–µ–Ω—Ç—ã">–ú–æ–ª–æ–¥–µ–∂—å –∏ —Å—Ç—É–¥–µ–Ω—Ç—ã</option>
                                <option value="–ø–æ–∂–∏–ª—ã–µ –ª—é–¥–∏">–ü–æ–∂–∏–ª—ã–µ –ª—é–¥–∏</option>
                                <option value="–æ–±—â–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è">–û–±—â–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</option>
                                <option value="–ª–∏–¥–µ—Ä—ã –∏ —Å–ª—É–∂–∏—Ç–µ–ª–∏">–õ–∏–¥–µ—Ä—ã –∏ —Å–ª—É–∂–∏—Ç–µ–ª–∏</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">–ì–ª–∞–≤–Ω–∞—è –ò–¥–µ—è <span class="text-red-500">*</span></label>
                            <div id="editor" class="w-full border border-gray-300 rounded-md focus:ring-2 focus:ring-[#2c7a7b] focus:ring-offset-2 focus:border-[#2c7a7b]"
                                 style="height: 450px;"></div>
                            <p id="editor-error" class="hidden text-xs text-red-600 mt-1"></p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <button onclick="App.getAssistance('exegesis')" id="btn-exegesis"
                                    class="btn-assist bg-[#2c7a7b] text-white font-semibold py-2 px-3 rounded-md shadow hover:shadow-md flex items-center justify-center text-sm">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                                –≠–∫–∑–µ–≥–µ–∑–∞
                            </button>
                            <button onclick="App.getAssistance('illustration')" id="btn-illustration"
                                    class="btn-assist bg-[#2c7a7b] text-white font-semibold py-2 px-3 rounded-md shadow hover:shadow-md flex items-center justify-center text-sm">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏
                            </button>
                            <button onclick="App.getAssistance('structure')" id="btn-structure"
                                    class="btn-assist bg-[#2c7a7b] text-white font-semibold py-2 px-3 rounded-md shadow hover:shadow-md flex items-center justify-center text-sm">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                                </svg>
                                –°—Ç—Ä—É–∫—Ç—É—Ä–∞
                            </button>
                        </div>
                        <div class="border-t border-gray-200 pt-2">
                            <p class="text-xs text-gray-600 mb-2 font-medium">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                                <button onclick="App.getAssistance('theology')" id="btn-theology"
                                        class="btn-assist bg-[#6366f1] text-white font-semibold py-2 px-3 rounded-md shadow hover:shadow-md flex items-center justify-center text-sm">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ–≥–æ—Å–ª–æ–≤–∏—è
                                </button>
                                <button onclick="App.getAssistance('style')" id="btn-style"
                                        class="btn-assist bg-[#8b5cf6] text-white font-semibold py-2 px-3 rounded-md shadow hover:shadow-md flex items-center justify-center text-sm">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                    –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∏–ª—è
                                </button>
                                <button onclick="App.getAssistance('questions')" id="btn-questions"
                                        class="btn-assist bg-[#ec4899] text-white font-semibold py-2 px-3 rounded-md shadow hover:shadow-md flex items-center justify-center text-sm">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –≥—Ä—É–ø–ø
                                </button>
                            </div>
                        </div>

                        <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ–º–ø—Ç—ã -->
                        <div id="custom-prompts-section" class="hidden border-t border-gray-200 pt-2 mt-2">
                            <p class="text-xs text-gray-600 mb-2 font-medium flex items-center justify-between">
                                <span>–ú–æ–∏ AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:</span>
                                <span class="badge-custom" id="custom-prompts-count">0</span>
                            </p>
                            <div id="custom-prompts-buttons" class="grid grid-cols-1 md:grid-cols-3 gap-2">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div id="loading-indicator" class="hidden text-center p-4 bg-yellow-50 rounded-md border border-yellow-200 mb-4">
                    <div class="loading-spinner inline-block mb-2"></div>
                    <p class="text-gray-700 text-sm font-medium">–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ü–∏—Å–∞–Ω–∏–µ...</p>
                </div>

                <!-- –û—à–∏–±–∫–∞ -->
                <div id="error-message" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-md mb-4 text-sm"></div>

                <!-- –°–µ–∫—Ü–∏–∏ AI —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ -->
                <div id="preparation-sections" class="hidden assistant-card bg-white rounded-lg border border-gray-200 mb-4">
                    <div class="border-b border-gray-200 px-4 pt-4">
                        <div class="flex space-x-1 -mb-px overflow-x-auto">
                            <button id="ai-tab-exegesis" onclick="App.switchAITab('exegesis')" 
                                    class="ai-tab px-4 py-2 text-sm font-medium text-gray-600 hover:text-[#2c7a7b] transition whitespace-nowrap">
                                <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                </svg>
                                –≠–∫–∑–µ–≥–µ–∑–∞
                            </button>
                            <button id="ai-tab-illustration" onclick="App.switchAITab('illustration')" 
                                    class="ai-tab px-4 py-2 text-sm font-medium text-gray-600 hover:text-[#2c7a7b] transition whitespace-nowrap">
                                <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏
                            </button>
                            <button id="ai-tab-structure" onclick="App.switchAITab('structure')" 
                                    class="ai-tab px-4 py-2 text-sm font-medium text-gray-600 hover:text-[#2c7a7b] transition whitespace-nowrap">
                                <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                                </svg>
                                –°—Ç—Ä—É–∫—Ç—É—Ä–∞
                            </button>
                            <button id="ai-tab-theology" onclick="App.switchAITab('theology')" 
                                    class="ai-tab px-4 py-2 text-sm font-medium text-gray-600 hover:text-[#6366f1] transition whitespace-nowrap">
                                <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                –ë–æ–≥–æ—Å–ª–æ–≤–∏–µ
                            </button>
                            <button id="ai-tab-style" onclick="App.switchAITab('style')" 
                                    class="ai-tab px-4 py-2 text-sm font-medium text-gray-600 hover:text-[#8b5cf6] transition whitespace-nowrap">
                                <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                –°—Ç–∏–ª—å
                            </button>
                            <button id="ai-tab-questions" onclick="App.switchAITab('questions')" 
                                    class="ai-tab px-4 py-2 text-sm font-medium text-gray-600 hover:text-[#ec4899] transition whitespace-nowrap">
                                <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                –í–æ–ø—Ä–æ—Å—ã
                            </button>
                        </div>
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –≤–∫–ª–∞–¥–æ–∫ -->
                    <div class="p-4">
                        <!-- –≠–∫–∑–µ–≥–µ–∑–∞ -->
                        <div id="ai-content-exegesis" class="ai-content-panel">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-base font-bold text-gray-800">–≠–∫–∑–µ–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ê–Ω–∞–ª–∏–∑</h3>
                                <button onclick="App.insertToEditor('exegesis')"
                                        class="bg-[#2c7a7b] text-white font-medium py-1.5 px-3 rounded-md hover:bg-[#235d5e] transition text-xs">
                                    –í—Å—Ç–∞–≤–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                                </button>
                            </div>
                            <div id="exegesis-content" class="text-sm prose max-w-none"></div>
                        </div>

                        <!-- –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ -->
                        <div id="ai-content-illustration" class="ai-content-panel">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-base font-bold text-gray-800">–ò–¥–µ–∏ –¥–ª—è –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–π</h3>
                                <button onclick="App.insertToEditor('illustration')"
                                        class="bg-[#2c7a7b] text-white font-medium py-1.5 px-3 rounded-md hover:bg-[#235d5e] transition text-xs">
                                    –í—Å—Ç–∞–≤–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                                </button>
                            </div>
                            <div id="illustration-content" class="text-sm prose max-w-none"></div>
                        </div>

                        <!-- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ -->
                        <div id="ai-content-structure" class="ai-content-panel">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-base font-bold text-gray-800">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–æ–ø–æ–≤–µ–¥–∏</h3>
                                <button onclick="App.insertToEditor('structure')"
                                        class="bg-[#2c7a7b] text-white font-medium py-1.5 px-3 rounded-md hover:bg-[#235d5e] transition text-xs">
                                    –í—Å—Ç–∞–≤–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                                </button>
                            </div>
                            <div id="structure-content" class="text-sm prose max-w-none"></div>
                        </div>

                        <!-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ–≥–æ—Å–ª–æ–≤–∏—è -->
                        <div id="ai-content-theology" class="ai-content-panel">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-base font-bold text-gray-800">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–æ–≥–æ—Å–ª–æ–≤–∏—è</h3>
                                <button onclick="App.insertToEditor('theology')"
                                        class="bg-[#6366f1] text-white font-medium py-1.5 px-3 rounded-md hover:bg-[#4f46e5] transition text-xs">
                                    –í—Å—Ç–∞–≤–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                                </button>
                            </div>
                            <div id="theology-content" class="text-sm prose max-w-none"></div>
                        </div>

                        <!-- –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∏–ª—è -->
                        <div id="ai-content-style" class="ai-content-panel">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-base font-bold text-gray-800">–£–ª—É—á—à–µ–Ω–∏–µ –°—Ç–∏–ª—è</h3>
                                <button onclick="App.insertToEditor('style')"
                                        class="bg-[#8b5cf6] text-white font-medium py-1.5 px-3 rounded-md hover:bg-[#7c3aed] transition text-xs">
                                    –í—Å—Ç–∞–≤–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                                </button>
                            </div>
                            <div id="style-content" class="text-sm prose max-w-none"></div>
                        </div>

                        <!-- –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –≥—Ä—É–ø–ø -->
                        <div id="ai-content-questions" class="ai-content-panel">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-base font-bold text-gray-800">–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –ú–∞–ª—ã—Ö –ì—Ä—É–ø–ø</h3>
                                <button onclick="App.insertToEditor('questions')"
                                        class="bg-[#ec4899] text-white font-medium py-1.5 px-3 rounded-md hover:bg-[#db2777] transition text-xs">
                                    –í—Å—Ç–∞–≤–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                                </button>
                            </div>
                            <div id="questions-content" class="text-sm prose max-w-none"></div>
                        </div>
                    </div>
                </div>

                <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—Å—Ç–∞–≤–∫–∏ —Å—Ç–∏—Ö–∞ -->
                <div id="bible-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-4 rounded-lg w-full max-w-sm">
                        <h3 class="text-base font-bold text-gray-800 mb-3">–í—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∏—Ö –∏–∑ –ü–∏—Å–∞–Ω–∏—è</h3>
                        <div class="mb-3 tooltip">
                            <label class="block text-xs font-medium text-gray-700 mb-1">–ë–∏–±–ª–µ–π—Å–∫–∏–π –æ—Ç—Ä—ã–≤–æ–∫ <span class="text-red-500">*</span></label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="bible-reference" list="book-list"
                                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#2c7a7b] focus:ring-offset-2 focus:border-[#2c7a7b]"
                                       placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö –†–∏–º–ª—è–Ω–∞–º 1:2" required>
                                <button onclick="App.showBookList()"
                                        class="bg-gray-200 text-gray-700 font-medium py-1.5 px-3 rounded-md hover:bg-gray-300 transition text-xs">–ö–Ω–∏–≥–∞</button>
                            </div>
                            <span class="tooltip-text">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –∏ –≥–ª–∞–≤—É/—Å—Ç–∏—Ö</span>
                            <datalist id="book-list"></datalist>
                            <p id="bible-reference-error" class="hidden text-xs text-red-600 mt-1"></p>
                        </div>
                        <div class="flex justify-end space-x-1.5">
                            <button onclick="App.closeBibleModal()"
                                    class="bg-gray-200 text-gray-700 font-medium py-1.5 px-3 rounded-md hover:bg-gray-300 transition text-xs">–û—Ç–º–µ–Ω–∞</button>
                            <button onclick="App.fetchBibleVerse()"
                                    class="bg-[#2c7a7b] text-white font-medium py-1.5 px-3 rounded-md hover:bg-[#235d5e] transition text-xs">–í—Å—Ç–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ====================== CUSTOM PROMPT MODAL ====================== -->
    <div id="custom-prompt-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-screen overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center">
                <h2 class="text-xl font-bold text-amber-600">–°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç</h2>
                <button onclick="App.closeCustomPromptModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="p-6">
                <div class="space-y-4">
                    <!-- –ü—Ä–µ—Å–µ—Ç—ã -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            üìã –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ç–æ–≤—ã–π —à–∞–±–ª–æ–Ω (–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π):
                        </label>
                        <select id="prompt-preset" onchange="App.loadPreset(this.value)"
                                class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                            <option value="">-- –°–æ–∑–¥–∞—Ç—å —Å –Ω—É–ª—è --</option>
                            <option value="parallel">–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ü–∏—Å–∞–Ω–∏–µ</option>
                            <option value="theology-check">–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–æ–≥–æ—Å–ª–æ–≤—Å–∫–∏–µ –æ—à–∏–±–∫–∏</option>
                            <option value="cultural">–ö—É–ª—å—Ç—É—Ä–Ω–æ-–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç</option>
                            <option value="original-language">–ê–Ω–∞–ª–∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö —è–∑—ã–∫–æ–≤ (–≥—Ä–µ—á./–µ–≤—Ä.)</option>
                            <option value="application">–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è –∂–∏–∑–Ω–∏</option>
                            <option value="prayer">–ú–æ–ª–∏—Ç–≤–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞</option>
                            <option value="children">–ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –¥–µ—Ç—Å–∫–æ–≥–æ —Å–ª—É–∂–µ–Ω–∏—è</option>
                            <option value="heresy-check">–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –µ—Ä–µ—Å–∏ –∏ –¥–æ–∫—Ç—Ä–∏–Ω–∞–ª—å–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è</option>
                            <option value="cross-cultural">–ö—Ä–æ—Å—Å-–∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ</option>
                            <option value="worship">–ò–¥–µ–∏ –¥–ª—è –ø–µ—Å–µ–Ω –∏ –ø–æ–∫–ª–æ–Ω–µ–Ω–∏—è</option>
                            <option value="evangelism">–ï–≤–∞–Ω–≥–µ–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã</option>
                            <option value="discipleship">–ü—É–Ω–∫—Ç—ã –¥–ª—è —É—á–µ–Ω–∏—á–µ—Å—Ç–≤–∞</option>
                        </select>
                    </div>

                    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            –ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞: <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="prompt-name" 
                               class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏">
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            –û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è AI (–∏–ª–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —à–∞–±–ª–æ–Ω):
                        </label>
                        <textarea id="prompt-description" 
                                  class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-500 focus:border-amber-500" 
                                  rows="6"
                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞–π–¥–∏ –≤—Å–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ –ü–∏—Å–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–≤—è–∑–∞–Ω—ã —Å —Ç–µ–º–æ–π –º–æ–µ–π –ø—Ä–æ–ø–æ–≤–µ–¥–∏. –£–∫–∞–∂–∏, –∫–∞–∫ —ç—Ç–∏ —Ç–µ–∫—Å—Ç—ã –¥–æ–ø–æ–ª–Ω—è—é—Ç –∏ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∏–¥–µ—é."></textarea>
                        <div class="mt-2 bg-blue-50 border border-blue-200 rounded-md p-3">
                            <p class="text-xs text-blue-900 font-medium mb-2">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—é –ø—Ä–æ–º–ø—Ç–∞:</p>
                            <ul class="text-xs text-blue-800 space-y-1">
                                <li>‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ: <code class="bg-white px-1 rounded">{passage}</code> - –±–∏–±–ª–µ–π—Å–∫–∏–π –æ—Ç—Ä—ã–≤–æ–∫, <code class="bg-white px-1 rounded">{main_idea}</code> - –≥–ª–∞–≤–Ω–∞—è –∏–¥–µ—è, <code class="bg-white px-1 rounded">{audience}</code> - –∞—É–¥–∏—Ç–æ—Ä–∏—è</li>
                                <li>‚Ä¢ –ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã: —É–∫–∞–∂–∏—Ç–µ –ß–¢–û –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –ö–ê–ö –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</li>
                                <li>‚Ä¢ –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: "–ü—Ä–µ–¥—Å—Ç–∞–≤—å –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞", "–†–∞–∑–¥–µ–ª–∏ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" –∏ —Ç.–¥.</li>
                                <li>‚Ä¢ –ü—Ä–∏–º–µ—Ä: "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π {passage} –∏ –Ω–∞–π–¥–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞. –î–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏: {audience}"</li>
                            </ul>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                    <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                        <button onclick="App.generateCustomPromptFromDescription()"
                                class="px-4 py-2 text-sm font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600 flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            –£–ª—É—á—à–∏—Ç—å —Å –ø–æ–º–æ—â—å—é AI
                        </button>
                        <div class="flex space-x-2">
                            <button onclick="App.closeCustomPromptModal()"
                                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                            <button onclick="App.saveCustomPromptDirect()"
                                    class="px-4 py-2 text-sm font-medium text-white bg-amber-500 rounded-md hover:bg-amber-600 flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ -->
                <div id="existing-prompts-section" class="mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-800 mb-3">–ú–æ–∏ AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
                    <div id="existing-prompts-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- –°–ø–∏—Å–æ–∫ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ====================== HELP MODAL ====================== -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div id="help-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-4 flex justify-between items-center">
                <h2 class="text-xl font-bold text-[#2c7a7b]">–ü–æ–º–æ—â—å: –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ü—Ä–æ–ø–æ–≤–µ–¥–Ω–∏–∫–∞ (–¥–µ–º–æ)</h2>
                <button onclick="App.closeHelpModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="p-6 space-y-6">
                <div class="flex space-x-1 border-b border-gray-200">
                    <button onclick="App.switchHelpTab('overview')" id="tab-overview" class="tab-active px-4 py-2 text-sm font-medium">
                        –û–±—â–µ–µ
                    </button>
                    <button onclick="App.switchHelpTab('sermon')" id="tab-sermon" class="tab-inactive px-4 py-2 text-sm font-medium">
                        –ü—Ä–æ–ø–æ–≤–µ–¥—å
                    </button>
                    <button onclick="App.switchHelpTab('ai')" id="tab-ai" class="tab-inactive px-4 py-2 text-sm font-medium">
                        AI-–ü–æ–º–æ—â–Ω–∏–∫
                    </button>
                    <button onclick="App.switchHelpTab('bible')" id="tab-bible" class="tab-inactive px-4 py-2 text-sm font-medium">
                        –ë–∏–±–ª–∏—è
                    </button>
                    <button onclick="App.switchHelpTab('export')" id="tab-export" class="tab-inactive px-4 py-2 text-sm font-medium">
                        –≠–∫—Å–ø–æ—Ä—Ç
                    </button>
                </div>

                <div id="help-content" class="text-sm text-gray-700 space-y-5">
                    <!-- –û–±—â–µ–µ -->
                    <div id="help-overview">
                        <h3 class="text-lg font-semibold text-[#2c7a7b] mb-3">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>
                        <p>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ü—Ä–æ–ø–æ–≤–µ–¥–Ω–∏–∫–∞ (–¥–µ–º–æ) ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –±–∏–±–ª–µ–π—Å–∫–∏—Ö –ø—Ä–æ–ø–æ–≤–µ–¥–µ–π —Å –ø–æ–º–æ—â—å—é –ò–ò –∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ü–∏—Å–∞–Ω–∏—é.</p>
                        <ul class="list-disc pl-5 space-y-1 mt-2">
                            <li>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –∏ —Ö—Ä–∞–Ω–∏—Ç–µ –ø—Ä–æ–ø–æ–≤–µ–¥–∏ –ª–æ–∫–∞–ª—å–Ω–æ</li>
                            <li>–ü–æ–ª—É—á–∞–π—Ç–µ —ç–∫–∑–µ–≥–µ–∑—É, –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ—Ç –ò–ò</li>
                            <li>–í—Å—Ç–∞–≤–ª—è–π—Ç–µ —Å—Ç–∏—Ö–∏ –∏–∑ –ë–∏–±–ª–∏–∏ –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º</li>
                            <li>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ DOCX –∏ JSON</li>
                        </ul>
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-3 mt-4">
                            <p class="text-xs font-medium text-blue-900">–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <strong>–≠–∫—Å–ø–æ—Ä—Ç JSON</strong> –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.</p>
                        </div>
                    </div>

                    <!-- –ü—Ä–æ–ø–æ–≤–µ–¥—å -->
                    <div id="help-sermon" class="hidden">
                        <h3 class="text-lg font-semibold text-[#2c7a7b] mb-3">–†–∞–±–æ—Ç–∞ —Å –ø—Ä–æ–ø–æ–≤–µ–¥—å—é</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-medium text-gray-800">–°–æ–∑–¥–∞–Ω–∏–µ</h4>
                                <p class="text-xs mt-1">–ù–∞–∂–º–∏—Ç–µ <strong>"–ù–æ–≤–∞—è –ü—Ä–æ–ø–æ–≤–µ–¥—å"</strong> –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –∏–ª–∏ –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤–æ–º —ç–∫—Ä–∞–Ω–µ.</p>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ</h4>
                                <ul class="text-xs list-disc pl-5 space-y-1 mt-1">
                                    <li><strong>–ù–∞–∑–≤–∞–Ω–∏–µ</strong> ‚Äî –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞</li>
                                    <li><strong>–ë–∏–±–ª–µ–π—Å–∫–∏–π –æ—Ç—Ä—ã–≤–æ–∫</strong> ‚Äî —Ñ–æ—Ä–º–∞—Ç: <code class="bg-gray-100 px-1 rounded">–ö –†–∏–º–ª—è–Ω–∞–º 8:28</code> –∏–ª–∏ <code class="bg-gray-100 px-1 rounded">–ò–æ–∞–Ω–Ω–∞ 3:16-18</code></li>
                                    <li><strong>–ì–ª–∞–≤–Ω–∞—è –∏–¥–µ—è (–Ω–∞–±—Ä–∞—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ)</strong> ‚Äî –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ</li>
                                </ul>
                            </div>
                            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3">
                                <p class="text-xs font-medium text-yellow-900">–ü—Ä–∏–º–µ—Ä –æ—Ç—Ä—ã–≤–∫–∞:</p>
                                <p class="text-xs mt-1"><code class="bg-gray-100 px-1 rounded">–ü—Å–∞–ª–æ–º 22:1-5</code> ‚Üí <em>–ì–æ—Å–ø–æ–¥—å ‚Äî –ü–∞—Å—Ç—ã—Ä—å –º–æ–π...</em></p>
                            </div>
                        </div>
                    </div>

                    <!-- AI -->
                    <div id="help-ai" class="hidden">
                        <h3 class="text-lg font-semibold text-[#2c7a7b] mb-3">AI-–ü–æ–º–æ—â–Ω–∏–∫</h3>
                        <p class="text-xs mb-3">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –æ–¥–Ω—É –∏–∑ –∫–Ω–æ–ø–æ–∫ –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è <strong>–æ—Ç—Ä—ã–≤–∫–∞</strong> –∏ <strong>–≥–ª–∞–≤–Ω–æ–π –∏–¥–µ–∏</strong>. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –≤–æ –≤–∫–ª–∞–¥–∫–∞—Ö –Ω–∏–∂–µ.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
                            <div class="border border-gray-200 rounded-md p-3 bg-teal-50">
                                <h4 class="font-semibold text-[#2c7a7b]">–≠–∫–∑–µ–≥–µ–∑–∞</h4>
                                <p class="mt-1">–ì–ª—É–±–æ–∫–∏–π —Ä–∞–∑–±–æ—Ä —Ç–µ–∫—Å—Ç–∞: –∫–æ–Ω—Ç–µ–∫—Å—Ç, –ª–µ–∫—Å–∏–∫–∞, –±–æ–≥–æ—Å–ª–æ–≤–∏–µ.</p>
                            </div>
                            <div class="border border-gray-200 rounded-md p-3 bg-teal-50">
                                <h4 class="font-semibold text-[#2c7a7b]">–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏</h4>
                                <p class="mt-1">–ü—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏, –∏—Å—Ç–æ—Ä–∏–∏, –ø—Ä–∏—Ä–æ–¥—ã ‚Äî –ø–æ–¥ –≤–∞—à—É –∞—É–¥–∏—Ç–æ—Ä–∏—é.</p>
                            </div>
                            <div class="border border-gray-200 rounded-md p-3 bg-teal-50">
                                <h4 class="font-semibold text-[#2c7a7b]">–°—Ç—Ä—É–∫—Ç—É—Ä–∞</h4>
                                <p class="mt-1">–í–≤–µ–¥–µ–Ω–∏–µ ‚Üí –û—Å–Ω–æ–≤–Ω—ã–µ –ø—É–Ω–∫—Ç—ã ‚Üí –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ ‚Üí –ó–∞–∫–ª—é—á–µ–Ω–∏–µ.</p>
                            </div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-md p-3 mt-3">
                            <p class="text-xs font-medium text-green-900">–ü–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ—Å—å –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –æ—Ç–≤–µ—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ <strong>"–í—Å—Ç–∞–≤–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä"</strong> ‚Äî —Ç–µ–∫—Å—Ç –¥–æ–±–∞–≤–∏—Ç—Å—è –≤ Quill.</p>
                        </div>
                    </div>

                    <!-- –ë–∏–±–ª–∏—è -->
                    <div id="help-bible" class="hidden">
                        <h3 class="text-lg font-semibold text-[#2c7a7b] mb-3">–í—Å—Ç–∞–≤–∫–∞ –∏–∑ –ë–∏–±–ª–∏–∏</h3>
                        <ol class="text-xs list-decimal pl-5 space-y-2">
                            <li>–í —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>–ë–∏–±–ª–∏—è</strong> –Ω–∞ –ø–∞–Ω–µ–ª–∏</li>
                            <li>–í–≤–µ–¥–∏—Ç–µ –æ—Ç—Ä—ã–≤–æ–∫: <code class="bg-gray-100 px-1 rounded">–ö –ì–∞–ª–∞—Ç–∞–º 5:22-23</code></li>
                            <li>–ù–∞–∂–º–∏—Ç–µ <strong>"–í—Å—Ç–∞–≤–∏—Ç—å"</strong></li>
                        </ol>
                        <div class="bg-purple-50 border border-purple-200 rounded-md p-3 mt-3">
                            <p class="text-xs font-medium text-purple-900">–†–µ–∑—É–ª—å—Ç–∞—Ç:</p>
                            <p class="text-xs mt-1 italic"><strong>–ö –ì–∞–ª–∞—Ç–∞–º 5:22-23:</strong> –ü–ª–æ–¥ –∂–µ –¥—É—Ö–∞: –ª—é–±–æ–≤—å, —Ä–∞–¥–æ—Å—Ç—å, –º–∏—Ä...</p>
                        </div>
                        <p class="text-xs mt-3 text-gray-600">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–≤–æ–¥ <strong>–°–∏–Ω–æ–¥–∞–ª—å–Ω—ã–π</strong>. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –¥–∏–∞–ø–∞–∑–æ–Ω—ã –∏ —Ü–µ–ª—ã–µ –≥–ª–∞–≤—ã.</p>
                    </div>

                    <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
                    <div id="help-export" class="hidden">
                        <h3 class="text-lg font-semibold text-[#2c7a7b] mb-3">–≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç</h3>
                        <div class="space-y-3 text-xs">
                            <div>
                                <h4 class="font-medium text-gray-800">DOCX</h4>
                                <p>–ì–æ—Ç–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –∏ –≤—Å–µ–º —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.</p>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800">JSON</h4>
                                <p>–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –≤—Å–µ—Ö –ø—Ä–æ–ø–æ–≤–µ–¥–µ–π. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.</p>
                            </div>
                            <div class="bg-orange-50 border border-orange-200 rounded-md p-3">
                                <p class="text-xs font-medium text-orange-900">–°–æ–≤–µ—Ç: –†–µ–≥—É–ª—è—Ä–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ JSON!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 border-t border-gray-200 p-4 text-center">
                <p class="text-xs text-gray-500">v1.0 ‚Ä¢ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ü—Ä–æ–ø–æ–≤–µ–¥–Ω–∏–∫–∞ (–¥–µ–º–æ)</p>
            </div>
        </div>
    </div>

<script src="editor.js"></script>
<script>
    const App = {
        sermons: null,
        currentSermonId: null,
        autoSaveTimer: null,
        editor: null,
        currentAITab: null,
        customPrompts: [],

        bookMap: {
            "–ë—ã—Ç–∏–µ":1,"–ò—Å—Ö–æ–¥":2,"–õ–µ–≤–∏—Ç":3,"–ß–∏—Å–ª–∞":4,"–í—Ç–æ—Ä–æ–∑–∞–∫–æ–Ω–∏–µ":5,"–ò–∏—Å—É—Å –ù–∞–≤–∏–Ω":6,"–ö–Ω–∏–≥–∞ –°—É–¥–µ–π":7,"–†—É—Ñ—å":8,
            "1-—è –¶–∞—Ä—Å—Ç–≤":9,"2-—è –¶–∞—Ä—Å—Ç–≤":10,"3-—è –¶–∞—Ä—Å—Ç–≤":11,"4-—è –¶–∞—Ä—Å—Ç–≤":12,"1-—è –ü–∞—Ä–∞–ª–∏–ø–æ–º–µ–Ω–æ–Ω":13,"2-—è –ü–∞—Ä–∞–ª–∏–ø–æ–º–µ–Ω–æ–Ω":14,
            "–ï–∑–¥—Ä–∞":15,"–ù–µ–µ–º–∏—è":16,"–ï—Å—Ñ–∏—Ä—å":17,"–ò–æ–≤":18,"–ü—Å–∞–ª—Ç–∏—Ä—å":19,"–ü—Ä–∏—Ç—á–∏":20,"–ï–∫–∫–ª–µ—Å–∏–∞—Å—Ç":21,"–ü–µ—Å–Ω–∏ –ü–µ—Å–Ω–µ–π":22,
            "–ò—Å–∞–∏—è":23,"–ò–µ—Ä–µ–º–∏—è":24,"–ü–ª–∞—á –ò–µ—Ä–µ–º–∏–∏":25,"–ò–µ–∑–µ–∫–∏–∏–ª—å":26,"–î–∞–Ω–∏–∏–ª":27,"–û—Å–∏—è":28,"–ò–æ–∏–ª—å":29,"–ê–º–æ—Å":30,
            "–ê–≤–¥–∏–π":31,"–ò–æ–Ω–∞":32,"–ú–∏—Ö–µ–π":33,"–ù–∞—É–º":34,"–ê–≤–≤–∞–∫—É–º":35,"–°–æ—Ñ–æ–Ω–∏—è":36,"–ê–≥–≥–µ–π":37,"–ó–∞—Ö–∞—Ä–∏—è":38,"–ú–∞–ª–∞—Ö–∏—è":39,
            "–û—Ç –ú–∞—Ç—Ñ–µ—è":40,"–ú–∞—Ç—Ñ–µ–π":40,"–û—Ç –ú–∞—Ä–∫–∞":41,"–ú–∞—Ä–∫":41,"–û—Ç –õ—É–∫–∏":42,"–õ—É–∫–∞":42,"–û—Ç –ò–æ–∞–Ω–Ω–∞":43,"–ò–æ–∞–Ω–Ω–∞":43,
            "–î–µ—è–Ω–∏—è":44,"–ö –†–∏–º–ª—è–Ω–∞–º":45,"–†–∏–º–ª—è–Ω–∞–º":45,"1-–µ –ö–æ—Ä–∏–Ω—Ñ—è–Ω–∞–º":46,"2-–µ –ö–æ—Ä–∏–Ω—Ñ—è–Ω–∞–º":47,"–ö –ì–∞–ª–∞—Ç–∞–º":48,"–ö –ï—Ñ–µ—Å—è–Ω–∞–º":49,
            "–ö –§–∏–ª–∏–ø–ø–∏–π—Ü–∞–º":50,"–§–∏–ª–∏–ø–ø–∏–π—Ü–∞–º":50,"–ö –ö–æ–ª–æ—Å—Å—è–Ω–∞–º":51,"–ö–æ–ª–æ—Å—Å—è–Ω–∞–º":51,"1-–µ –§–µ—Å—Å–∞–ª–æ–Ω–∏–∫–∏–π—Ü–∞–º":52,"2-–µ –§–µ—Å—Å–∞–ª–æ–Ω–∏–∫–∏–π—Ü–∞–º":53,
            "1-–µ –¢–∏–º–æ—Ñ–µ—é":54,"2-–µ –¢–∏–º–æ—Ñ–µ—é":55,"–ö –¢–∏—Ç—É":56,"–ö –§–∏–ª–∏–º–æ–Ω—É":57,"–ö –ï–≤—Ä–µ—è–º":58,"–ò–∞–∫–æ–≤–∞":59,"1-–µ –ü–µ—Ç—Ä–∞":60,
            "2-–µ –ü–µ—Ç—Ä–∞":61,"1-–µ –ò–æ–∞–Ω–Ω–∞":62,"2-–µ –ò–æ–∞–Ω–Ω–∞":63,"3-–µ –ò–æ–∞–Ω–Ω–∞":64,"–ò—É–¥–∞":65,"–û—Ç–∫—Ä–æ–≤–µ–Ω–∏–µ":66,
            "2 –∫–Ω. –ï–∑–¥—Ä—ã":67,"–¢–æ–≤–∏—Ç":68,"–ò—É–¥–∏—Ñ—å":69,"–ü—Ä–µ–º—É–¥—Ä–æ—Å—Ç—å –°–æ–ª–æ–º–æ–Ω–∞":70,"–°–∏—Ä–∞—Ö":71,
            "–ü–æ—Å–ª–∞–Ω–∏–µ –ò–µ—Ä–µ–º–∏–∏":72,"–í–∞—Ä—É—Ö":73,"1 –∫–Ω. –ú–∞–∫–∫–∞–≤–µ–π—Å–∫–∞—è":74,"2 –∫–Ω. –ú–∞–∫–∫–∞–≤–µ–π—Å–∫–∞—è":75,
            "3 –∫–Ω. –ú–∞–∫–∫–∞–≤–µ–π—Å–∫–∞—è":76,"3 –∫–Ω. –ï–∑–¥—Ä—ã":77
        },

        init() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
            if (!StorageManager.isAvailable()) alert('localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!');
            this.sermons = StorageManager.load();
            this.loadCustomPrompts();
            this.renderSermonsList();
            this.renderCustomPrompts();
            this.showWelcomeScreen();
            if (this.sermons.settings.auto_save) {
                this.autoSaveTimer = setInterval(() => StorageManager.save(this.sermons), CONFIG.STORAGE.AUTO_SAVE_INTERVAL);
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
            this.editor = new EditorManager('editor', () => this.updateSermonMetadata());

            console.log('–ì–æ—Ç–æ–≤–æ');
        },

        switchAITab(tab) {
            this.currentAITab = tab;
            
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.ai-tab').forEach(t => {
                t.classList.remove('ai-tab-active');
                t.classList.add('text-gray-600');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ
            const activeTab = document.getElementById(`ai-tab-${tab}`);
            if (activeTab) {
                activeTab.classList.add('ai-tab-active');
                activeTab.classList.remove('text-gray-600');
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–∞–Ω–µ–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            document.querySelectorAll('.ai-content-panel').forEach(p => {
                p.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
            const activePanel = document.getElementById(`ai-content-${tab}`);
            if (activePanel) {
                activePanel.classList.add('active');
            }
        },

        findClosestBookName(input) {
            const clean = input.toLowerCase().replace(/[^–∞-—èa-z0-9]/g, '');
            let best = null, minDist = Infinity;
            for (const book of Object.keys(this.bookMap)) {
                const bookClean = book.toLowerCase().replace(/[^–∞-—èa-z0-9]/g, '');
                const dist = this.levenshteinDistance(clean, bookClean);
                if (dist < minDist && dist <= 3) {
                    minDist = dist;
                    best = book;
                }
            }
            return best;
        },

        levenshteinDistance(a, b) {
            const m = [];
            for (let i = 0; i <= b.length; i++) m[i] = [i];
            for (let j = 0; j <= a.length; j++) m[0][j] = j;
            for (let i = 1; i <= b.length; i++)
                for (let j = 1; j <= a.length; j++) {
                    m[i][j] = b[i-1] === a[j-1]
                        ? m[i-1][j-1]
                        : Math.min(m[i-1][j-1] + 1, m[i][j-1] + 1, m[i-1][j] + 1);
                }
            return m[b.length][a.length];
        },

        showBookList() {
            alert('–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–∏–≥–∏:\n\n' + Object.keys(this.bookMap).sort().join('\n'));
        },

        validatePassage(input) {
            const val = input.value.trim();
            const err = document.getElementById(input.id === 'passage' ? 'passage-error' : 'bible-reference-error');
            if (!val) {
                input.setAttribute('aria-invalid', 'true');
                err.textContent = '–ü–æ–ª–µ –ø—É—Å—Ç–æ';
                err.classList.remove('hidden');
                return false;
            }

            const chapterMatch = val.match(/(\d+[:]\d*)/);
            if (!chapterMatch) {
                input.setAttribute('aria-invalid', 'true');
                err.textContent = '–£–∫–∞–∂–∏—Ç–µ –≥–ª–∞–≤—É/—Å—Ç–∏—Ö';
                err.classList.remove('hidden');
                return false;
            }

            const chapterPos = chapterMatch.index;
            const rawBook = val.substring(0, chapterPos).trim();
            const rest = val.substring(chapterPos).trim();

            let bookName = Object.keys(this.bookMap).find(k => k.toLowerCase() === rawBook.toLowerCase());
            if (!bookName) {
                bookName = this.findClosestBookName(rawBook);
                if (!bookName) {
                    input.setAttribute('aria-invalid', 'true');
                    err.textContent = '–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
                    err.classList.remove('hidden');
                    return false;
                }
                input.value = `${bookName} ${rest}`;
            }

            const m = rest.match(/^(\d+)(?::(\d+)(?:-(\d+))?)?$/);
            if (!m) {
                input.setAttribute('aria-invalid', 'true');
                err.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≥–ª–∞–≤—ã/—Å—Ç–∏—Ö–∞';
                err.classList.remove('hidden');
                return false;
            }
            const [, c, s, e] = m;
            if (s && e && +e < +s) {
                input.setAttribute('aria-invalid', 'true');
                err.textContent = '–ö–æ–Ω–µ—á–Ω—ã–π —Å—Ç–∏—Ö –º–µ–Ω—å—à–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ';
                err.classList.remove('hidden');
                return false;
            }

            input.setAttribute('aria-invalid', 'false');
            err.classList.add('hidden');
            return true;
        },

        validateTitle(inp) {
            const v = inp.value.trim();
            const e = document.getElementById('sermon-title-error');
            if (v.length < 3) {
                inp.setAttribute('aria-invalid', 'true');
                e.textContent = '–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                e.classList.remove('hidden');
                return false;
            }
            inp.setAttribute('aria-invalid', 'false');
            e.classList.add('hidden');
            return true;
        },

        validateEditor() {
            const txt = this.editor?.getText() || '';
            const e = document.getElementById('editor-error');
            if (txt.length < 10) {
                e.textContent = '–ú–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤';
                e.classList.remove('hidden');
                return false;
            }
            e.classList.add('hidden');
            return true;
        },

        showWelcomeScreen() {
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('sermon-workspace').classList.add('hidden');
            document.getElementById('sermon-actions').classList.add('hidden');
            document.getElementById('main-subtitle').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–ø–æ–≤–µ–¥—å –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é';
        },

        showSermonWorkspace() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('sermon-workspace').classList.remove('hidden');
            document.getElementById('sermon-actions').classList.remove('hidden');
        },

        createNewSermon() {
            const s = {
                id: Utils.generateSermonId(),
                metadata: {
                    title: "–ù–æ–≤–∞—è –ø—Ä–æ–ø–æ–≤–µ–¥—å",
                    passage: "",
                    audience: this.sermons.settings.default_audience,
                    date_created: Utils.getCurrentISODate(),
                    date_modified: Utils.getCurrentISODate(),
                    date_preached: "",
                    status: CONFIG.DEFAULTS.STATUS,
                    tags: [],
                    duration_planned: this.sermons.settings.default_duration
                },
                preparation: {
                    main_idea: "",
                    exegesis: { content: "", ai_generated: false, date_generated: null },
                    illustrations: { content: "", ai_generated: false, date_generated: null },
                    structure: { content: "", ai_generated: false, date_generated: null },
                    theology: { content: "", ai_generated: false, date_generated: null },
                    style: { content: "", ai_generated: false, date_generated: null },
                    questions: { content: "", ai_generated: false, date_generated: null }
                },
                sermon_text: { introduction: "", main_body: "", conclusion: "", full_text: "" },
                notes: [],
                resources: []
            };
            this.sermons.sermons.unshift(s);
            this.currentSermonId = s.id;
            StorageManager.save(this.sermons);
            this.renderSermonsList();
            this.loadSermon(s.id);
        },

        loadSermon(id) {
            this.currentSermonId = id;
            const s = this.sermons.sermons.find(x => x.id === id);
            if (!s) return;

            this.showSermonWorkspace();

            const el = {
                title: document.getElementById('sermon-title'),
                date: document.getElementById('sermon-date'),
                status: document.getElementById('sermon-status'),
                duration: document.getElementById('sermon-duration'),
                passage: document.getElementById('passage'),
                audience: document.getElementById('audience'),
                subtitle: document.getElementById('main-subtitle')
            };

            el.subtitle.textContent = s.metadata.passage || '–£–∫–∞–∂–∏—Ç–µ –æ—Ç—Ä—ã–≤–æ–∫';
            el.title.value = s.metadata.title || '';
            this.validateTitle(el.title);

            el.date.value = Utils.formatInputDate(s.metadata.date_preached) || '';
            el.status.value = s.metadata.status || CONFIG.DEFAULTS.STATUS;
            el.duration.value = s.metadata.duration_planned || CONFIG.DEFAULTS.DURATION;
            el.passage.value = s.metadata.passage || '';
            this.validatePassage(el.passage);

            el.audience.value = s.metadata.audience || CONFIG.DEFAULTS.AUDIENCE;

            this.editor.setHTML(s.preparation.main_idea || '');
            this.validateEditor();

            this.displayPreparationSection('exegesis', s.preparation.exegesis);
            this.displayPreparationSection('illustration', s.preparation.illustrations);
            this.displayPreparationSection('structure', s.preparation.structure);
            this.displayPreparationSection('theology', s.preparation.theology);
            this.displayPreparationSection('style', s.preparation.style);
            this.displayPreparationSection('questions', s.preparation.questions);

            document.querySelectorAll('.sermon-item').forEach(i => i.classList.toggle('active', i.dataset.id === id));
        },

        displayPreparationSection(type, data) {
            const map = {
                exegesis: 'exegesis-content',
                illustration: 'illustration-content',
                structure: 'structure-content',
                theology: 'theology-content',
                style: 'style-content',
                questions: 'questions-content'
            };
            
            // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
            let contentId = map[type];
            if (!contentId && type.startsWith('custom_')) {
                contentId = type + '-content';
            }
            
            const cont = document.getElementById(contentId);
            
            if (!cont || !data || !data.content) {
                if (cont) cont.innerHTML = '<p class="text-gray-500 italic">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞–∂–º–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.</p>';
                return;
            }

            cont.innerHTML = Utils.formatMarkdown(data.content);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å –≤–∫–ª–∞–¥–∫–∞–º–∏, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—å –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç
            const hasAnyContent = this.sermons.sermons.find(x => x.id === this.currentSermonId)?.preparation;
            if (hasAnyContent) {
                let hasContent = hasAnyContent.exegesis.content || hasAnyContent.illustrations.content || 
                    hasAnyContent.structure.content || hasAnyContent.theology.content || 
                    hasAnyContent.style.content || hasAnyContent.questions.content;
                    
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–æ–º–ø—Ç—ã
                if (!hasContent) {
                    for (let key in hasAnyContent) {
                        if (key.startsWith('custom_') && hasAnyContent[key].content) {
                            hasContent = true;
                            break;
                        }
                    }
                }
                
                if (hasContent) {
                    document.getElementById('preparation-sections').classList.remove('hidden');
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –≤–∫–ª–∞–¥–∫—É
                    if (!this.currentAITab) {
                        if (hasAnyContent.exegesis.content) this.switchAITab('exegesis');
                        else if (hasAnyContent.illustrations.content) this.switchAITab('illustration');
                        else if (hasAnyContent.structure.content) this.switchAITab('structure');
                        else if (hasAnyContent.theology.content) this.switchAITab('theology');
                        else if (hasAnyContent.style.content) this.switchAITab('style');
                        else if (hasAnyContent.questions.content) this.switchAITab('questions');
                    }
                }
            }
        },

        updateSermonMetadata() {
            if (!this.currentSermonId) return;
            const s = this.sermons.sermons.find(x => x.id === this.currentSermonId);
            if (!s) return;

            const el = {
                title: document.getElementById('sermon-title'),
                passage: document.getElementById('passage'),
                audience: document.getElementById('audience'),
                status: document.getElementById('sermon-status'),
                duration: document.getElementById('sermon-duration'),
                date: document.getElementById('sermon-date'),
                subtitle: document.getElementById('main-subtitle')
            };

            let ok = true;
            if (el.title && !this.validateTitle(el.title)) ok = false;
            if (el.passage && !this.validatePassage(el.passage)) ok = false;
            if (!this.validateEditor()) ok = false;
            if (!ok) return;

            s.metadata.title = el.title.value;
            s.metadata.passage = el.passage.value;
            s.metadata.audience = el.audience.value;
            s.metadata.status = el.status.value;
            s.metadata.duration_planned = +el.duration.value || CONFIG.DEFAULTS.DURATION;
            s.metadata.date_preached = el.date.value ? new Date(el.date.value).toISOString() : '';
            s.preparation.main_idea = this.editor.getHTML() || '';
            s.metadata.date_modified = Utils.getCurrentISODate();
            el.subtitle.textContent = s.metadata.passage || '–£–∫–∞–∂–∏—Ç–µ –æ—Ç—Ä—ã–≤–æ–∫';

            StorageManager.save(this.sermons);
            this.renderSermonsList();
        },

        saveCurrentSermon() {
            this.updateSermonMetadata();
            const b = event.target;
            b.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
            setTimeout(() => b.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 1500);
        },

        deleteCurrentSermon() {
            if (!this.currentSermonId || !confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–ø–æ–≤–µ–¥—å?')) return;
            this.sermons.sermons = this.sermons.sermons.filter(x => x.id !== this.currentSermonId);
            this.currentSermonId = null;
            StorageManager.save(this.sermons);
            this.renderSermonsList();
            if (this.sermons.sermons.length === 0) this.showWelcomeScreen();
            else this.loadSermon(this.sermons.sermons[0].id);
        },

        renderSermonsList() {
            const list = document.getElementById('sermons-list');
            if (!list) return;
            list.innerHTML = this.sermons.sermons.length === 0
                ? '<p class="text-gray-500 text-xs text-center py-6">–ù–µ—Ç –ø—Ä–æ–ø–æ–≤–µ–¥–µ–π</p>'
                : this.sermons.sermons.map(s => {
                    const st = Utils.getStatusText(s.metadata.status);
                    const d = Utils.formatDisplayDate(s.metadata.date_created);
                    return `<div class="sermon-item p-2 mb-1.5 rounded-md border border-gray-200 ${s.id === this.currentSermonId ? 'active' : ''}"
                                data-id="${s.id}" onclick="App.loadSermon('${s.id}')">
                                <div class="flex items-start justify-between mb-0.5">
                                    <h4 class="font-semibold text-gray-800 text-xs flex-1">${s.metadata.title}</h4>
                                    <span class="status-badge status-${s.metadata.status} ml-1.5">${st}</span>
                                </div>
                                <p class="text-xs text-gray-600 mb-0.5">${s.metadata.passage || '–ë–µ–∑ –æ—Ç—Ä—ã–≤–∫–∞'}</p>
                                <p class="text-xs text-gray-500">${d}</p>
                            </div>`;
                }).join('');
        },

        exportToJSON() { StorageManager.exportToJSON(this.sermons); },
        
        async importFromJSON(e) {
            const f = e.target.files[0];
            if (!f) return;
            try {
                const imp = await StorageManager.importFromJSON(f);
                if (confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.')) {
                    this.sermons = imp;
                    StorageManager.save(this.sermons);
                    this.renderSermonsList();
                    if (this.sermons.sermons.length) this.loadSermon(this.sermons.sermons[0].id);
                    alert('–ò–º–ø–æ—Ä—Ç —É—Å–ø–µ—à–µ–Ω');
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ' + err.message);
            }
            e.target.value = '';
        },

        async getAssistance(mode) {
            if (!this.currentSermonId) { this.displayError('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–ø–æ–≤–µ–¥—å'); return; }
            
            document.getElementById('error-message').classList.add('hidden');
            
            const passageInp = document.getElementById('passage');
            const audience = document.getElementById('audience').value || CONFIG.DEFAULTS.AUDIENCE;

            if (!this.validatePassage(passageInp) || !this.validateEditor()) {
                this.displayError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Ç—Ä—ã–≤–æ–∫ –∏ –≥–ª–∞–≤–Ω—É—é –∏–¥–µ—é');
                return;
            }

            const passage = passageInp.value.trim();
            const draft = this.editor.getText();
            const fullText = this.editor.getHTML();

            this.setLoading(true);
            let query = '', section = '';
            
            switch (mode) {
                case 'exegesis':
                    section = 'exegesis';
                    query = CONFIG.PROMPTS.EXEGESIS(passage, draft);
                    break;
                case 'illustration':
                    section = 'illustrations';
                    query = CONFIG.PROMPTS.ILLUSTRATION(passage, draft, audience);
                    break;
                case 'structure':
                    section = 'structure';
                    query = CONFIG.PROMPTS.STRUCTURE(passage, draft, audience);
                    break;
                case 'theology':
                    section = 'theology';
                    query = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â—É—é –ø—Ä–æ–ø–æ–≤–µ–¥—å –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –±–∏–±–ª–µ–π—Å–∫–æ–º—É —É—á–µ–Ω–∏—é. –ü—Ä–æ–≤–µ—Ä—å:
1. –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç—É –ü–∏—Å–∞–Ω–∏—è
2. –ë–æ–≥–æ—Å–ª–æ–≤—Å–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
3. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –±–∏–±–ª–µ–π—Å–∫–∏—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤
4. –í–æ–∑–º–æ–∂–Ω—ã–µ –±–æ–≥–æ—Å–ª–æ–≤—Å–∫–∏–µ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ –∏–ª–∏ –æ—à–∏–±–∫–∏

–ë–∏–±–ª–µ–π—Å–∫–∏–π –æ—Ç—Ä—ã–≤–æ–∫: ${passage}
–¢–µ–∫—Å—Ç –ø—Ä–æ–ø–æ–≤–µ–¥–∏: ${draft}

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é.`;
                    break;
                case 'style':
                    section = 'style';
                    query = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å—Ç–∏–ª—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–ø–æ–≤–µ–¥–∏. –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:
1. –Ø—Å–Ω–æ—Å—Ç—å –∏ –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å –∏–∑–ª–æ–∂–µ–Ω–∏—è
2. –õ–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—ã—Å–ª–µ–π
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–π
4. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å
5. –ì—Ä–∞–º–º–∞—Ç–∏–∫–∞ –∏ —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–∞

–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: ${audience}
–ë–∏–±–ª–µ–π—Å–∫–∏–π –æ—Ç—Ä—ã–≤–æ–∫: ${passage}
–¢–µ–∫—Å—Ç –ø—Ä–æ–ø–æ–≤–µ–¥–∏: ${draft}

–ü—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏.`;
                    break;
                case 'questions':
                    section = 'questions';
                    query = `–°–æ–∑–¥–∞–π 8-12 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –≤ –º–∞–ª—ã—Ö –≥—Ä—É–ø–ø–∞—Ö –ø–æ —ç—Ç–æ–π –ø—Ä–æ–ø–æ–≤–µ–¥–∏:

–ë–∏–±–ª–µ–π—Å–∫–∏–π –æ—Ç—Ä—ã–≤–æ–∫: ${passage}
–û—Å–Ω–æ–≤–Ω–∞—è –∏–¥–µ—è: ${draft}

–í–æ–ø—Ä–æ—Å—ã –¥–æ–ª–∂–Ω—ã:
1. –ü–æ–º–æ–≥–∞—Ç—å –≥–ª—É–±–∂–µ –ø–æ–Ω—è—Ç—å —Ç–µ–∫—Å—Ç –ü–∏—Å–∞–Ω–∏—è
2. –ü—Ä–∏–º–µ–Ω—è—Ç—å –∏—Å—Ç–∏–Ω—ã –∫ –∂–∏–∑–Ω–∏
3. –°—Ç–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ –∏ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ
4. –ë—ã—Ç—å –ø–æ–¥—Ö–æ–¥—è—â–∏–º–∏ –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏: ${audience}
5. –í–∫–ª—é—á–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã —Ä–∞–∑–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è (–æ—Ç –ø—Ä–æ—Å—Ç—ã—Ö –∫ —Å–ª–æ–∂–Ω—ã–º)

–†–∞–∑–¥–µ–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ, –õ–∏—á–Ω–æ–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ.`;
                    break;
                default:
                    this.displayError('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø–æ–º–æ—â–∏');
                    this.setLoading(false);
                    return;
            }

            const payload = {
                model: CONFIG.API.MODEL,
                messages: [
                    { role: "system", content: CONFIG.PROMPTS.SYSTEM },
                    { role: "user", content: query }
                ],
                temperature: CONFIG.API.TEMPERATURE,
                max_tokens: CONFIG.API.MAX_TOKENS
            };

            for (let i = 0; i < CONFIG.API.MAX_RETRIES; i++) {
                try {
                    const r = await fetch(CONFIG.API.URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${CONFIG.API.KEY}`
                        },
                        body: JSON.stringify(payload)
                    });
                    if (!r.ok) {
                        if (r.status === 429 && i < CONFIG.API.MAX_RETRIES - 1) {
                            await new Promise(res => setTimeout(res, Utils.getRetryDelay(i)));
                            continue;
                        }
                        throw new Error(`API ${r.status}`);
                    }
                    const d = await r.json();
                    if (d.choices?.[0]?.message?.content) {
                        const txt = d.choices[0].message.content;
                        const s = this.sermons.sermons.find(x => x.id === this.currentSermonId);
                        if (s) {
                            s.preparation[section] = { content: txt, ai_generated: true, date_generated: Utils.getCurrentISODate() };
                            s.metadata.date_modified = Utils.getCurrentISODate();
                            StorageManager.save(this.sermons);
                            this.displayPreparationSection(mode, s.preparation[section]);
                            
                            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å –Ω–æ–≤—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
                            this.switchAITab(mode);
                        }
                        this.setLoading(false);
                        break;
                    }
                    throw new Error('–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞');
                } catch (e) {
                    console.error(e);
                    if (i === CONFIG.API.MAX_RETRIES - 1) {
                        this.displayError('–û—à–∏–±–∫–∞ AI: ' + e.message);
                        this.setLoading(false);
                    }
                }
            }
        },

        setLoading(flag) {
            document.querySelectorAll('.btn-assist').forEach(b => b.disabled = flag);
            document.getElementById('loading-indicator').classList.toggle('hidden', !flag);
            document.getElementById('error-message').classList.add('hidden');
        },

        displayError(msg) {
            const el = document.getElementById('error-message');
            el.textContent = '–û—à–∏–±–∫–∞: ' + msg;
            el.classList.remove('hidden');
        },

        insertToEditor(type) {
            const map = {
                exegesis: 'exegesis-content',
                illustration: 'illustration-content',
                structure: 'structure-content',
                theology: 'theology-content',
                style: 'style-content',
                questions: 'questions-content'
            };
            
            // –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ–º–ø—Ç–æ–≤
            let contentId = map[type];
            if (!contentId && type.startsWith('custom_')) {
                contentId = type + '-content';
            }
            
            const el = document.getElementById(contentId);
            if (!el || !this.editor) {
                this.displayError('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏');
                return;
            }
            const html = el.innerHTML.trim();
            if (!html || html.includes('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')) {
                this.displayError('–ü—É—Å—Ç–æ');
                return;
            }
            this.editor.insertHTML(html);
            this.updateSermonMetadata();
        },

        openBibleModal() {
            document.getElementById('bible-modal').classList.remove('hidden');
            document.getElementById('bible-reference').focus();
        },

        closeBibleModal() {
            const m = document.getElementById('bible-modal');
            if (m) m.classList.add('hidden');
            const inp = document.getElementById('bible-reference');
            if (inp) {
                inp.value = '';
                inp.setAttribute('aria-invalid', 'false');
            }
            document.getElementById('bible-reference-error').classList.add('hidden');
        },

        async fetchBibleVerse() {
            const ref = document.getElementById('bible-reference');
            const val = ref.value.trim();
            if (!val) {
                ref.setAttribute('aria-invalid', 'true');
                document.getElementById('bible-reference-error').textContent = '–ü—É—Å—Ç–æ';
                document.getElementById('bible-reference-error').classList.remove('hidden');
                return;
            }
            if (!this.validatePassage(ref)) return;

            const [ , chapterVerse ] = ref.value.split(' ');
            const m = chapterVerse.match(/^(\d+)(?::(\d+)(?:-(\d+))?)?$/);
            if (!m) return;
            const [, c, s, e] = m;
            const bookId = this.bookMap[Object.keys(this.bookMap).find(k => k.toLowerCase() === ref.value.split(' ')[0].toLowerCase())];

            this.setLoading(true);
            try {
                let verses = [];
                if (s && e) for (let v = +s; v <= +e; v++) verses.push(v);
                else if (s) verses.push(+s);
                else {
                    const r = await fetch(`https://bolls.life/get-text/SYNOD/${bookId}/${c}/`);
                    if (!r.ok) throw new Error('API');
                    const d = await r.json();
                    verses = d.map(x => x.verse);
                }

                const r = await fetch(`https://bolls.life/get-text/SYNOD/${bookId}/${c}/`);
                if (!r.ok) throw new Error('API');
                const data = await r.json();
                let html = '';
                verses.forEach(v => {
                    const o = data.find(x => x.verse === v);
                    if (o) html += `<p><strong>${ref.value.split(' ')[0]} ${c}:${v}:</strong> ${o.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</p>`;
                });
                if (!html) throw new Error('–°—Ç–∏—Ö–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');

                this.editor.insertHTML(html);
                this.updateSermonMetadata();
                this.closeBibleModal();
            } catch (err) {
                ref.setAttribute('aria-invalid', 'true');
                document.getElementById('bible-reference-error').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: ' + err.message;
                document.getElementById('bible-reference-error').classList.remove('hidden');
            } finally {
                this.setLoading(false);
            }
        },

        exportToDocx() {
            if (!this.currentSermonId) {
                this.displayError('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–ø–æ–≤–µ–¥—å');
                return;
            }
            const s = this.sermons.sermons.find(x => x.id === this.currentSermonId);
            if (!s) {
                this.displayError('–ü—Ä–æ–ø–æ–≤–µ–¥—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                return;
            }

            const hasContent = s.metadata.title || s.metadata.passage || this.editor.getHTML() ||
                               s.preparation.exegesis.content || s.preparation.illustrations.content || s.preparation.structure.content;
            if (!hasContent) {
                this.displayError('–ü—Ä–æ–ø–æ–≤–µ–¥—å –ø—É—Å—Ç–∞');
                return;
            }

            const docxStyles = `
                <style>
                    @page { size: A4; margin: 1cm; }
                    body { font-family: 'Inter', Arial, sans-serif; font-size: 8pt; line-height: 1.3; color: #1f2937; margin: 0; padding: 0 0.8cm; }
                    h1 { font-size: 11pt; font-weight: 700; color: #111827; margin: 0.8em 0 0.4em; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.15em; }
                    h2 { font-size: 10pt; font-weight: 600; color: #111827; margin: 0.7em 0 0.4em; }
                    h3 { font-size: 9pt; font-weight: 500; color: #1f2937; margin: 0.6em 0 0.3em; }
                    p { margin: 0 0 0.5em; text-align: justify; }
                    ul, ol { margin: 0.5em 0; padding-left: 1em; }
                    li { margin-bottom: 0.15em; font-size: 8pt; }
                    strong { font-weight: 700; }
                    .meta { margin-bottom: 1em; }
                    .meta p { margin: 0.25em 0; font-size: 7.5pt; }
                </style>
            `;

            const html = `
                <!DOCTYPE html>
                <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/1999/xhtml">
                <head><meta charset="UTF-8"><title>${this.escapeHtml(s.metadata.title || '–ü—Ä–æ–ø–æ–≤–µ–¥—å')}</title>${docxStyles}</head>
                <body>
                    <h1>${this.escapeHtml(s.metadata.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}</h1>
                    <div class="meta">
                        <p><strong>–û—Ç—Ä—ã–≤–æ–∫:</strong> ${this.escapeHtml(s.metadata.passage || '‚Äî')}</p>
                        <p><strong>–ê—É–¥–∏—Ç–æ—Ä–∏—è:</strong> ${this.escapeHtml(s.metadata.audience || '‚Äî')}</p>
                        <p><strong>–î–∞—Ç–∞ –ø—Ä–æ–ø–æ–≤–µ–¥–∏:</strong> ${Utils.formatDisplayDate(s.metadata.date_preached) || '‚Äî'}</p>
                        <p><strong>–ü–ª–∞–Ω–∏—Ä—É–µ–º–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${s.metadata.duration_planned || 30} –º–∏–Ω</p>
                    </div>
                    <h2>–ì–ª–∞–≤–Ω–∞—è –ò–¥–µ—è</h2>
                    ${this.editor.getHTML() ? this.sanitizeForDocx(this.editor.getHTML()) : '<p>‚Äî</p>'}
                    <h2>–≠–∫–∑–µ–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –ê–Ω–∞–ª–∏–∑</h2>
                    ${s.preparation.exegesis.content ? this.sanitizeForDocx(Utils.formatMarkdown(s.preparation.exegesis.content)) : '<p>‚Äî</p>'}
                    <h2>–ò–¥–µ–∏ –¥–ª—è –ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–π</h2>
                    ${s.preparation.illustrations.content ? this.sanitizeForDocx(Utils.formatMarkdown(s.preparation.illustrations.content)) : '<p>‚Äî</p>'}
                    <h2>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü—Ä–æ–ø–æ–≤–µ–¥–∏</h2>
                    ${s.preparation.structure.content ? this.sanitizeForDocx(Utils.formatMarkdown(s.preparation.structure.content)) : '<p>‚Äî</p>'}
                    ${s.preparation.theology.content ? `<h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–æ–≥–æ—Å–ª–æ–≤–∏—è</h2>${this.sanitizeForDocx(Utils.formatMarkdown(s.preparation.theology.content))}` : ''}
                    ${s.preparation.style.content ? `<h2>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –°—Ç–∏–ª—é</h2>${this.sanitizeForDocx(Utils.formatMarkdown(s.preparation.style.content))}` : ''}
                    ${s.preparation.questions.content ? `<h2>–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –ú–∞–ª—ã—Ö –ì—Ä—É–ø–ø</h2>${this.sanitizeForDocx(Utils.formatMarkdown(s.preparation.questions.content))}` : ''}
                </body>
                </html>`;

            try {
                const blob = htmlDocx.asBlob(html, { orientation: 'portrait', margins: { top: 1440, right: 1440, bottom: 1440, left: 1440 } });
                const filename = `–ü—Ä–æ–ø–æ–≤–µ–¥—å_${(s.metadata.title || '–ë–µ–∑–ù–∞–∑–≤–∞–Ω–∏—è').replace(/[^a-zA-Z0-9–ê-–Ø–∞-—è]/g, '_')}_${Utils.getCurrentISODate().split('T')[0]}.docx`;
                saveAs(blob, filename);
            } catch (err) {
                console.error('DOCX Export Error:', err);
                this.displayError('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + err.message);
            }
        },

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },

        sanitizeForDocx(html) {
            return html
                .replace(/<br>/gi, '<br/>')
                .replace(/ class="[^"]*"/gi, '')
                .replace(/ style="[^"]*"/gi, '')
                .replace(/<p>\s*<\/p>/gi, '');
        },

        openHelpModal() {
            document.getElementById('help-modal').classList.remove('hidden');
            this.switchHelpTab('overview');
        },

        closeHelpModal() {
            document.getElementById('help-modal').classList.add('hidden');
        },

        switchHelpTab(tab) {
            document.querySelectorAll('#help-content > div').forEach(d => d.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(b => {
                b.classList.remove('tab-active');
                b.classList.add('tab-inactive');
            });

            document.getElementById(`help-${tab}`).classList.remove('hidden');
            const btn = document.getElementById(`tab-${tab}`);
            btn.classList.remove('tab-inactive');
            btn.classList.add('tab-active');
        },

        // =================== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨–°–ö–ò–ï –ü–†–û–ú–ü–¢–´ ===================
        
        loadCustomPrompts() {
            const saved = localStorage.getItem('customPrompts');
            this.customPrompts = saved ? JSON.parse(saved) : [];
        },

        saveCustomPromptsToStorage() {
            localStorage.setItem('customPrompts', JSON.stringify(this.customPrompts));
        },

        openCustomPromptModal() {
            document.getElementById('custom-prompt-modal').classList.remove('hidden');
            this.renderExistingPromptsList();
        },

        closeCustomPromptModal() {
            document.getElementById('custom-prompt-modal').classList.add('hidden');
            // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
            document.getElementById('prompt-preset').value = '';
            document.getElementById('prompt-name').value = '';
            document.getElementById('prompt-description').value = '';
        },

        loadPreset(presetType) {
            const presets = {
                'parallel': {
                    name: '–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏',
                    description: '–ù–∞–π–¥–∏ –≤—Å–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –º–µ—Å—Ç–∞ –≤ –ü–∏—Å–∞–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–≤—è–∑–∞–Ω—ã —Å –æ—Ç—Ä—ã–≤–∫–æ–º {passage} –∏ —Ç–µ–º–æ–π –º–æ–µ–π –ø—Ä–æ–ø–æ–≤–µ–¥–∏: {main_idea}. –£–∫–∞–∂–∏, –∫–∞–∫ —ç—Ç–∏ —Ç–µ–∫—Å—Ç—ã –¥–æ–ø–æ–ª–Ω—è—é—Ç –∏ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∏–¥–µ—é. –°–≥—Ä—É–ø–ø–∏—Ä—É–π –ø–æ —Ç–µ–º–∞–º.'
                },
                'theology-check': {
                    name: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ–≥–æ—Å–ª–æ–≤–∏—è',
                    description: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–ø–æ–≤–µ–¥—å –ø–æ –æ—Ç—Ä—ã–≤–∫—É {passage} —Å –≥–ª–∞–≤–Ω–æ–π –∏–¥–µ–µ–π: {main_idea}. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ä—Ç–æ–¥–æ–∫—Å–∞–ª—å–Ω–æ–º—É –±–∏–±–ª–µ–π—Å–∫–æ–º—É —É—á–µ–Ω–∏—é. –£–∫–∞–∂–∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –±–æ–≥–æ—Å–ª–æ–≤—Å–∫–∏–µ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ –∏–ª–∏ —Å–ø–æ—Ä–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.'
                },
                'cultural': {
                    name: '–ö—É–ª—å—Ç—É—Ä–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç',
                    description: '–û–ø–∏—à–∏ –∫—É–ª—å—Ç—É—Ä–Ω–æ-–∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–∏–±–ª–µ–π—Å–∫–æ–≥–æ –æ—Ç—Ä—ã–≤–∫–∞ {passage}. –ö–∞–∫ –∂–∏–ª–∏ –ª—é–¥–∏ —Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏? –ö–∞–∫–∏–µ –∫—É–ª—å—Ç—É—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤–∞–∂–Ω—ã –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞? –ö–∞–∫ —ç—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å–∫—Ä—ã—Ç—å –∏–¥–µ—é: {main_idea}?'
                },
                'original-language': {
                    name: '–ê–Ω–∞–ª–∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞',
                    description: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ {passage} –Ω–∞ —è–∑—ã–∫–µ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ (–≥—Ä–µ—á–µ—Å–∫–∏–π/–µ–≤—Ä–µ–π—Å–∫–∏–π). –û–±—ä—è—Å–Ω–∏ –∏—Ö –∑–Ω–∞—á–µ–Ω–∏–µ, –æ—Ç—Ç–µ–Ω–∫–∏ —Å–º—ã—Å–ª–∞, –∫–∞–∫ –æ–Ω–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—Ç –≥–ª—É–±–∏–Ω—É —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ç–µ–º—ã: {main_idea}.'
                },
                'application': {
                    name: '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ',
                    description: '–ù–∞ –æ—Å–Ω–æ–≤–µ {passage} –∏ –∏–¥–µ–∏ {main_idea}, —Å–æ–∑–¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏: {audience}. –ö–∞–∫ —ç—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω—É—é –∂–∏–∑–Ω—å? –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã.'
                },
                'prayer': {
                    name: '–ú–æ–ª–∏—Ç–≤–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã',
                    description: '–°–æ–∑–¥–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–ª–∏—Ç–≤–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ {passage} –∏ —Ç–µ–º—ã {main_idea}. –†–∞–∑–¥–µ–ª–∏ –Ω–∞: –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å, –∏—Å–ø–æ–≤–µ–¥–∞–Ω–∏–µ, –ø—Ä–æ—à–µ–Ω–∏—è, –ø–æ—Å–≤—è—â–µ–Ω–∏–µ. –î–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏: {audience}.'
                },
                'children': {
                    name: '–î–ª—è –¥–µ—Ç–µ–π',
                    description: '–ê–¥–∞–ø—Ç–∏—Ä—É–π –æ—Ç—Ä—ã–≤–æ–∫ {passage} –∏ –∏–¥–µ—é {main_idea} –¥–ª—è –¥–µ—Ç—Å–∫–æ–≥–æ —Å–ª—É–∂–µ–Ω–∏—è. –ü—Ä–µ–¥–ª–æ–∂–∏ –ø—Ä–æ—Å—Ç—ã–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è, –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥—É—Ç –¥–µ—Ç—è–º –ø–æ–Ω—è—Ç—å –∏ –∑–∞–ø–æ–º–Ω–∏—Ç—å –∏—Å—Ç–∏–Ω—É.'
                },
                'heresy-check': {
                    name: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –µ—Ä–µ—Å–∏',
                    description: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–æ–ø–æ–≤–µ–¥—å –ø–æ {passage} —Å –∏–¥–µ–µ–π {main_idea}. –ü—Ä–æ–≤–µ—Ä—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –µ—Ä–µ—Å–µ–π (–≥–Ω–æ—Å—Ç–∏—Ü–∏–∑–º, –ø–µ–ª–∞–≥–∏–∞–Ω—Å—Ç–≤–æ, –∞—Ä–∏–∞–Ω—Å—Ç–≤–æ –∏ —Ç.–¥.). –£–∫–∞–∂–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –¥–æ–∫—Ç—Ä–∏–Ω–∞–ª—å–Ω—ã–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è.'
                },
                'cross-cultural': {
                    name: '–ö—Ä–æ—Å—Å-–∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ',
                    description: '–ö–∞–∫ –∏—Å—Ç–∏–Ω—É –∏–∑ {passage} –∏ –∏–¥–µ—é {main_idea} –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ —Ä–∞–∑–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞—Ö? –ß—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ, –∞ —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –∫—É–ª—å—Ç—É—Ä–Ω–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–∏? –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫—É–ª—å—Ç—É—Ä.'
                },
                'worship': {
                    name: '–ò–¥–µ–∏ –¥–ª—è –ø–æ–∫–ª–æ–Ω–µ–Ω–∏—è',
                    description: '–ù–∞ –æ—Å–Ω–æ–≤–µ {passage} –∏ —Ç–µ–º—ã {main_idea}, –ø—Ä–µ–¥–ª–æ–∂–∏ –∏–¥–µ–∏ –¥–ª—è –ø–µ—Å–µ–Ω –ø–æ–∫–ª–æ–Ω–µ–Ω–∏—è, –º–æ–ª–∏—Ç–≤–µ–Ω–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤, –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ª—É–∂–µ–Ω–∏—è. –ö–∞–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –ë–æ–≥–∞ –º–æ–∂–Ω–æ –ø—Ä–æ—Å–ª–∞–≤–∏—Ç—å?'
                },
                'evangelism': {
                    name: '–ï–≤–∞–Ω–≥–µ–ª–∏–∑–∞—Ü–∏—è',
                    description: '–ù–∞–π–¥–∏ –≤ {passage} –∏ —Ç–µ–º–µ {main_idea} –º–æ–º–µ–Ω—Ç—ã –¥–ª—è –±–ª–∞–≥–æ–≤–µ—Å—Ç–∏—è. –ö–∞–∫ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –≤–ø–ª–µ—Å—Ç–∏ –ï–≤–∞–Ω–≥–µ–ª–∏–µ? –ö–∞–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å —É –Ω–µ–≤–µ—Ä—É—é—â–∏—Ö? –ö–∞–∫ –æ—Ç–≤–µ—Ç–∏—Ç—å?'
                },
                'discipleship': {
                    name: '–£—á–µ–Ω–∏—á–µ—Å—Ç–≤–æ',
                    description: '–°–æ–∑–¥–∞–π –ø—É–Ω–∫—Ç—ã –¥–ª—è —Ä–æ—Å—Ç–∞ —É—á–µ–Ω–∏–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ {passage} –∏ {main_idea}. –ö–∞–∫–∏–µ –Ω–∞–≤—ã–∫–∏ —Ä–∞–∑–≤–∏–≤–∞—Ç—å? –ö–∞–∫–∏–µ –ø—Ä–∏–≤—ã—á–∫–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å? –ö–∞–∫ –∏–∑–º–µ—Ä–∏—Ç—å —Ä–æ—Å—Ç? –î–ª—è –∞—É–¥–∏—Ç–æ—Ä–∏–∏: {audience}.'
                }
            };

            if (presets[presetType]) {
                document.getElementById('prompt-name').value = presets[presetType].name;
                document.getElementById('prompt-description').value = presets[presetType].description;
            }
        },

        async generateCustomPromptFromDescription() {
            const description = document.getElementById('prompt-description').value.trim();
            const name = document.getElementById('prompt-name').value.trim();

            if (!description) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è AI');
                return;
            }

            if (!name) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞');
                return;
            }

            this.setLoading(true);

            const metaPrompt = `–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø—Ä–æ–ø–æ–≤–µ–¥–Ω–∏–∫–∞–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞. 
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—Å–∞–ª –∑–∞–¥–∞—á—É: "${description}"

–£–ª—É—á—à–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–ø—Ç, —Å–¥–µ–ª–∞–≤ –µ–≥–æ –±–æ–ª–µ–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º. 

–í–ê–ñ–ù–û: 
- –°–æ—Ö—Ä–∞–Ω–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ {passage}, {main_idea}, {audience} –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
- –î–æ–±–∞–≤—å –∏—Ö, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç, –Ω–æ –æ–Ω–∏ —É–º–µ—Å—Ç–Ω—ã
- –°–¥–µ–ª–∞–π –ø—Ä–æ–º–ø—Ç —á–µ—Ç–∫–∏–º, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º
- –î–æ–±–∞–≤—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ AI
- –£–∫–∞–∂–∏ –∂–µ–ª–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞
- –ë—É–¥—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π.`;

            try {
                const response = await fetch(CONFIG.API.URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.API.KEY}`
                    },
                    body: JSON.stringify({
                        model: CONFIG.API.MODEL,
                        messages: [
                            { role: "system", content: "–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è AI." },
                            { role: "user", content: metaPrompt }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const data = await response.json();
                const improvedPrompt = data.choices?.[0]?.message?.content;

                if (!improvedPrompt) throw new Error('–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI');

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
                document.getElementById('prompt-description').value = improvedPrompt;

            } catch (error) {
                console.error('Error improving prompt:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–ª—É—á—à–µ–Ω–∏–∏ –ø—Ä–æ–º–ø—Ç–∞: ' + error.message);
            } finally {
                this.setLoading(false);
            }
        },

        saveCustomPromptDirect() {
            const name = document.getElementById('prompt-name').value.trim();
            const promptText = document.getElementById('prompt-description').value.trim();

            if (!name) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞');
                return;
            }

            if (!promptText) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
                return;
            }

            const customPrompt = {
                id: 'custom_' + Date.now(),
                name: name,
                description: '',
                systemRole: '',
                promptText: promptText,
                temperature: 0.7,
                maxTokens: 2000,
                dateCreated: Utils.getCurrentISODate()
            };

            this.customPrompts.push(customPrompt);
            this.saveCustomPromptsToStorage();
            this.renderCustomPrompts();
            this.renderExistingPromptsList();
            
            this.closeCustomPromptModal();
        },

        renderCustomPrompts() {
            const section = document.getElementById('custom-prompts-section');
            const buttonsContainer = document.getElementById('custom-prompts-buttons');
            const counter = document.getElementById('custom-prompts-count');

            if (this.customPrompts.length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');
            counter.textContent = this.customPrompts.length;

            buttonsContainer.innerHTML = this.customPrompts.map(prompt => `
                <button onclick="App.runCustomPrompt('${prompt.id}')" 
                        class="btn-assist bg-amber-500 text-white font-semibold py-2 px-3 rounded-md shadow hover:shadow-md flex items-center justify-center text-sm relative group">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    <span class="truncate">${prompt.name}</span>
                    <button onclick="event.stopPropagation(); App.deleteCustomPrompt('${prompt.id}')" 
                            class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-xs">
                        √ó
                    </button>
                </button>
            `).join('');
        },

        renderExistingPromptsList() {
            const list = document.getElementById('existing-prompts-list');
            
            if (this.customPrompts.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm italic text-center py-4">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤</p>';
                return;
            }

            list.innerHTML = this.customPrompts.map(prompt => `
                <div class="custom-prompt-item p-3 border border-gray-200 rounded-md flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800 text-sm">${prompt.name}</h4>
                        <p class="text-xs text-gray-600 mt-1">${prompt.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                        <p class="text-xs text-gray-400 mt-1">${Utils.formatDisplayDate(prompt.dateCreated)}</p>
                    </div>
                    <div class="flex space-x-1 ml-2">
                        <button onclick="App.editCustomPrompt('${prompt.id}')" 
                                class="text-blue-600 hover:text-blue-800 p-1" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button onclick="App.deleteCustomPrompt('${prompt.id}')" 
                                class="text-red-600 hover:text-red-800 p-1" title="–£–¥–∞–ª–∏—Ç—å">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        },

        editCustomPrompt(id) {
            const prompt = this.customPrompts.find(p => p.id === id);
            if (!prompt) return;

            document.getElementById('prompt-preset').value = '';
            document.getElementById('prompt-name').value = prompt.name;
            document.getElementById('prompt-description').value = prompt.promptText;

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–º–ø—Ç, —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å –µ–≥–æ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
            this.customPrompts = this.customPrompts.filter(p => p.id !== id);
            this.saveCustomPromptsToStorage();
            this.renderCustomPrompts();
        },

        deleteCustomPrompt(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç?')) return;
            
            this.customPrompts = this.customPrompts.filter(p => p.id !== id);
            this.saveCustomPromptsToStorage();
            this.renderCustomPrompts();
            this.renderExistingPromptsList();
        },

        async runCustomPrompt(id) {
            const prompt = this.customPrompts.find(p => p.id === id);
            if (!prompt) return;

            if (!this.currentSermonId) {
                this.displayError('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–ø–æ–≤–µ–¥—å');
                return;
            }

            const passageInp = document.getElementById('passage');
            const audience = document.getElementById('audience').value || CONFIG.DEFAULTS.AUDIENCE;

            if (!this.validatePassage(passageInp) || !this.validateEditor()) {
                this.displayError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Ç—Ä—ã–≤–æ–∫ –∏ –≥–ª–∞–≤–Ω—É—é –∏–¥–µ—é');
                return;
            }

            const passage = passageInp.value.trim();
            const mainIdea = this.editor.getText();

            // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –ø—Ä–æ–º–ø—Ç–µ
            let finalPrompt = prompt.promptText
                .replace(/{passage}/g, passage)
                .replace(/{main_idea}/g, mainIdea)
                .replace(/{audience}/g, audience);

            this.setLoading(true);

            const messages = [
                { role: "user", content: finalPrompt }
            ];

            if (prompt.systemRole) {
                messages.unshift({ role: "system", content: prompt.systemRole });
            }

            try {
                const response = await fetch(CONFIG.API.URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.API.KEY}`
                    },
                    body: JSON.stringify({
                        model: CONFIG.API.MODEL,
                        messages: messages,
                        temperature: prompt.temperature,
                        max_tokens: prompt.maxTokens
                    })
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const data = await response.json();
                const result = data.choices?.[0]?.message?.content;

                if (!result) throw new Error('–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI');

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ø—Ä–æ–ø–æ–≤–µ–¥–∏
                const s = this.sermons.sermons.find(x => x.id === this.currentSermonId);
                if (s) {
                    // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
                    const sectionKey = `custom_${id}`;
                    s.preparation[sectionKey] = {
                        content: result,
                        promptName: prompt.name,
                        ai_generated: true,
                        date_generated: Utils.getCurrentISODate()
                    };
                    s.metadata.date_modified = Utils.getCurrentISODate();
                    StorageManager.save(this.sermons);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –≤–∫–ª–∞–¥–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                    this.addCustomPromptTab(id, prompt.name);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    this.displayPreparationSection(sectionKey, s.preparation[sectionKey]);
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
                    this.switchAITab(sectionKey);
                }

            } catch (error) {
                console.error('Error running custom prompt:', error);
                this.displayError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏: ' + error.message);
            } finally {
                this.setLoading(false);
            }
        },

        addCustomPromptTab(id, name) {
            const tabsContainer = document.querySelector('#preparation-sections .flex.space-x-1');
            const contentContainer = document.querySelector('#preparation-sections > div.p-4');
            const sectionKey = `custom_${id}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –≤–∫–ª–∞–¥–∫–∞
            if (document.getElementById(`ai-tab-${sectionKey}`)) return;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∫–ª–∞–¥–∫—É
            const tabHTML = `
                <button id="ai-tab-${sectionKey}" onclick="App.switchAITab('${sectionKey}')" 
                        class="ai-tab px-4 py-2 text-sm font-medium text-gray-600 hover:text-amber-500 transition whitespace-nowrap">
                    <svg class="w-4 h-4 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    ${name}
                </button>
            `;
            tabsContainer.insertAdjacentHTML('beforeend', tabHTML);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            const contentHTML = `
                <div id="ai-content-${sectionKey}" class="ai-content-panel">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-base font-bold text-gray-800">${name}</h3>
                        <button onclick="App.insertToEditor('${sectionKey}')"
                                class="bg-amber-500 text-white font-medium py-1.5 px-3 rounded-md hover:bg-amber-600 transition text-xs">
                            –í—Å—Ç–∞–≤–∏—Ç—å –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä
                        </button>
                    </div>
                    <div id="${sectionKey}-content" class="text-sm prose max-w-none"></div>
                </div>
            `;
            contentContainer.insertAdjacentHTML('beforeend', contentHTML);
        },
    };

    window.onload = () => App.init();
    window.addEventListener('beforeunload', e => {
        StorageManager.save(App.sermons);
        if (App.sermons.sermons.some(s => s.metadata.status === 'draft')) {
            e.preventDefault();
            e.returnValue = '–ï—Å—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏';
        }
    });
</script>
</body>
</html>